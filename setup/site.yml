---

- name: Bootstrap Ansible settings
  hosts: localhost

  vars:
    default_hostname: "{{ current_hostname if current_hostname is defined else '' }}"
    default_email: "{{ current_email if current_email is defined else '' }}"
    vault_password_file: "{{ ansible_user_dir }}/.ansible/vault"

  vars_prompt:
    - name: vault_password
      prompt: Enter vault password
      unsafe: true
      confirm: true
    - name: hostname
      prompt: Enter system hostname
      private: false
      default: "{{ default_hostname }}"
    - name: email
      prompt: Enter email address
      private: false
      default: "{{ default_email }}"
    - name: ssh_key_types_to_generate
      prompt: SSH key types to generate
      private: false
      default: "rsa,ed25519"
    - name: clone_personal_repos
      prompt: Clone all personal GitHub repos (True|False)
      private: false
      default: true
    - name: use_personal_ssh_config
      prompt: Use personal SSH config (True|False)
      private: false
      default: true
    - name: work_system
      prompt: Install employer settings and scripts (True|False)
      private: false
      default: false

  tasks:
    - name: Create vault file
      ansible.builtin.copy:
        content: "{{ vault_password }}"
        dest: "{{ vault_password_file }}"
        mode: 0400

    - name: Generate SSH key passphrases
      vars:
        passphrase: "{{ lookup('password', ansible_user_dir + '/.ssh/id_' + item + '.passphrase') }}"
      ansible.builtin.command: "ansible-vault encrypt_string '{{ passphrase }}' --vault-password-file '{{ vault_password_file }}' --name {{ item }}"
      loop: "{{ ssh_key_types_to_generate | split(',') }}"
      register: ansible_vault

    - name: Create inventory
      ansible.builtin.template:
        src: inventory.yml.j2
        dest: "{{ ansible_user_dir }}/.ansible/inventory.yml"
        mode: 0755
