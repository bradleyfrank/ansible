---

- name: "Create inventory"
  hosts: all

  vars:
    default_inventory_branch: "main"
    host_vars: "{{ ansible_facts['user_dir'] }}/.ansible/inventory/host_vars/{{ system_hostname }}.yml"

  vars_prompt:
    - name: "system_hostname"
      prompt: "Enter system hostname"
      private: false
    - name: "email_address"
      prompt: "Enter email address"
      private: false
    - name: "git_inventory_repo"
      prompt: "Git repository URL for inventory"
      private: false
    - name: "git_inventory_branch"
      prompt: "Repository branch for inventory"
      private: false
      default: "{{ default_inventory_branch }}"

  tasks:
    - name: "Include 1Password role"
      ansible.builtin.import_role:
        name: "onepassword"

    - name: "Clone inventory repository"
      ansible.builtin.git:
        repo: "{{ git_inventory_repo }}"
        dest: "{{ ansible_facts['user_dir'] }}/.ansible/inventory"
        accept_hostkey: true
        version: "{{ git_inventory_branch }}"

    # TODO: host_vars entry may already exist; check first

    - name: "Create host_vars"
      ansible.builtin.template:
        src: "host_vars.yml.j2"
        dest: "{{ host_vars }}"
        mode: "0755"

    - name: "Create inventory"
      ansible.builtin.template:
        src: "inventory.yml.j2"
        dest: "{{ ansible_facts['user_dir'] }}/.ansible/inventory/inventory.yml"
        decrypt: false
        mode: "0755"
