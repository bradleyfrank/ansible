---

- name: Apply dotfiles to localhost
  hosts: localhost
  tasks:
    - name: Include system variables
      ansible.builtin.include_vars: "system_{{ ansible_system }}"

    - name: Include Linux distribution variables
      ansible.builtin.include_vars: "os_{{ distro_vars[ansible_distribution] }}"
      when: ansible_system == 'Linux'

    - name: Setup user directory
      ansible.builtin.include_tasks: user.yml

    - name: Create dotfile directory structure
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/{{ item.path }}"
        state: directory
        mode: 0755
      with_filetree: dotfiles/
      when: item.state == 'directory'

    - name: Install dotfiles
      ansible.builtin.copy:
        src: "{{ item.src }}"
        dest: "{{ ansible_user_dir }}/{{ item.path }}"
        mode: 0644
      with_filetree: dotfiles/
      when: item.state == 'file'

    - name: Install VSCode configs
      ansible.builtin.copy:
        src: conf/vscode/
        dest: "{{ vscode['config'] }}"
        mode: 0755

    - name: Check if kubectl is installed
      command: which kubectl
      changed_when: false
      failed_when: kubectl_installed.rc not in [0,1]
      register: kubectl_installed

    - name: Find latest kubectl release
      ansible.builtin.get_url:
        url: https://dl.k8s.io/release/stable.txt
        dest: /tmp/kubectl.txt
      when: kubectl_installed.rc == 1

    - name: Install kubectl
      vars:
        url: https://storage.googleapis.com/kubernetes-release/release
        system: "{{ ansible_system | lower }}"
        release: "{{ lookup('file', '/tmp/kubectl.txt') }}"
      ansible.builtin.get_url:
        url: "{{ url }}/{{ release }}/bin/{{ system }}/amd64/kubectl"
        dest: "{{ ansible_user_dir }}/.local/bin/"
        mode: 0755
      when: kubectl_installed.rc == 1

    - name: Copy fonts
      ansible.builtin.copy:
        src: fonts/
        dest: "{{ font_dir }}/"
        mode: 0644

    - name: Set proper permissions on ~/.ssh/config
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/.ssh/config"
        state: touch
        mode: 0644

    - name: Set proper permissions on ~/.ssh/authorized_keys
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/.ssh/authorized_keys"
        state: touch
        mode: 0600

    - name: Install vim extensions
      ansible.builtin.git:
        repo: "{{ item.repo }}"
        dest: "{{ vim_extensions_dest }}/{{ item.name }}"
        depth: '1'
        version: "{{ item.version | default(omit) }}"
      loop: "{{ vim_extensions }}"

    - name: Generate kubectl completions
      vars:
        kubectl_completion: "{{ ansible_user_dir }}/.local/share/k8s/kubectl.zsh"
      environment:
        PATH: "{{ ansible_env.PATH }}:{{ ansible_user_dir }}/.local/bin"
      ansible.builtin.shell: "kubectl completion zsh > {{ kubectl_completion }}"

    - name: Register Python3 user base location
      ansible.builtin.command: python3 -m site --user-base
      register: python3_user_base  # to add Python bin to macOS PATH
      check_mode: false
      when: ansible_system == 'Darwin'

    - name: Build zshrc
      ansible.builtin.template:
        src: zshrc.j2
        dest: "{{ ansible_user_dir }}/.zshrc"
        mode: 0644
