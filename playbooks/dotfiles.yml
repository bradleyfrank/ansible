---

- name: Install and configure dotfiles on localhost
  hosts: localhost

  handlers:
    - name: Process backups
      vars:
        backup_var: "{{ lookup('vars', item) }}"
      ansible.builtin.include_tasks: handlers/backups.yml
      when: backup_var['backup_file'] is defined
      loop: "{{ query('varnames', '^_backup_.+$') }}"
      loop_control:
        label: "{{ item | replace('_backup_', '') }}"
      tags: ['always', 'backups']

  tasks:

# ============================================================================
#  dotfiles and command line configuration
# ----------------------------------------------------------------------------

    - name: Create ~/Development folder structure
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/Development/{{ item }}"
        state: directory
        mode: 0755
      loop: ['Projects', 'Build', 'Scratch', 'Reference', 'Logs']
      tags: core

    - name: Create dotfile directory structure
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/{{ item['path'] }}"
        state: directory
        mode: 0755
      loop: "{{ lookup('community.general.filetree', 'dotfiles/') }}"
      loop_control:
        label: "{{ item['path'] }}"
      when: item['state'] == 'directory'
      tags: core

    - name: Install dotfiles
      ansible.builtin.copy:
        src: "{{ item['src'] }}"
        dest: "{{ ansible_user_dir }}/{{ item['path'] }}"
        mode: 0644
      loop: "{{ lookup('community.general.filetree', 'dotfiles/') }}"
      loop_control:
        label: "{{ item['path'] }}"
      when: item['state'] == 'file'
      tags: core

    - name: Make scripts executable
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/.local/bin"
        state: directory
        mode: 0755
        recurse: true
      tags: core

    - name: Install themes for bat
      ansible.builtin.command: "bat cache --build"
      changed_when: false
      tags: core

    - name: Install gitconfig
      ansible.builtin.template:
        src: gitconfig.j2
        dest: "{{ ansible_user_dir }}/.gitconfig"
        mode: 0755
        backup: true
      register: _backup_gitconfig
      notify: Process backups
      tags: [core, git]

    - name: Ensure backup directory exists
      ansible.builtin.file:
        path: "{{ backups_dir }}"
        state: directory
        mode: 0755
      tags: always

    - name: Import ssh tasks
      ansible.builtin.import_tasks: tasks/dotfiles/ssh.yml
      tags: [ssh, core]

    - name: Import tmux tasks
      ansible.builtin.import_tasks: tasks/dotfiles/tmux.yml
      tags: [tmux, core]

    - name: Import vim tasks
      ansible.builtin.import_tasks: tasks/dotfiles/vim.yml
      tags: [vim, core]

    - name: Include k8s tasks
      ansible.builtin.include_tasks:
        file: tasks/dotfiles/k8s.yml
        apply:
          tags: k8s
      tags: [kubectl, krew, stern, k9s]

# ============================================================================
#  assets and modules
# ----------------------------------------------------------------------------

    - name: Ensure fonts directory exists
      ansible.builtin.file:
        path: "{{ font_dir[ansible_distribution] }}"
        state: directory
        mode: 0700
      tags: fonts

    - name: Copy fonts
      ansible.builtin.copy:
        src: fonts/
        dest: "{{ font_dir[ansible_distribution] }}/"
        mode: 0644
      when: "'desktop' in system_type"
      tags: fonts

    - name: Import GitHub tasks
      ansible.builtin.import_tasks: tasks/dotfiles/github.yml
      tags: github

    - name: Install Python packages
      ansible.builtin.pip:
        executable: "{{ pip[ansible_distribution] }}"
        name: "{{ pypi_packages }}"
        extra_args: --user
      tags: python

# ============================================================================
#  gui apps configuration
# ----------------------------------------------------------------------------

    - name: Ensure ~/.config/alacritty directory exists
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/.config/alacritty"
        state: directory
        mode: 0755

    - name: Apply Alacritty template
      ansible.builtin.template:
        src: alacritty.yml.j2
        dest: "{{ ansible_user_dir }}/.config/alacritty/alacritty.yml"
        mode: 0644
        backup: true
      register: _backup_alacritty
      notify: Process backups

    - name: Import BBEdit tasks
      ansible.builtin.import_tasks: tasks/dotfiles/bbedit.yml
      when: "'MacOSX' in ansible_distribution"
      tags: bbedit

    - name: Update macOS app icons
      vars:
        app: "/Applications/{{ item['path'] | splitext | first }}.app"
      ansible.builtin.include_tasks: tasks/dotfiles/mac_icons.yml
      when: "'MacOSX' in ansible_distribution"
      loop: "{{ lookup('community.general.filetree', 'macOS/icons/') }}"
      loop_control:
        label: "{{ app }}"
      tags: icons

# ============================================================================
#  zsh and completions
# ----------------------------------------------------------------------------

    - name: Import Zsh tasks
      ansible.builtin.import_tasks: tasks/dotfiles/zsh.yml
      tags: zsh
