---

- name: Install and configure dotfiles on localhost
  hosts: localhost

  handlers:
    - name: Process backups
      vars:
        backup_var: "{{ lookup('vars', item) }}"
      ansible.builtin.include_tasks: tasks/backups.yml
      when: backup_var['backup_file'] is defined
      loop: "{{ query('varnames', '^_backup_.+$') }}"
      loop_control:
        label: "{{ item | replace('_backup_', '') }}"
      tags: ['always', 'backups']

  tasks:

# ============================================================================
#  dotfiles & command line configuration
# ----------------------------------------------------------------------------

    - name: Create ~/Development folder structure
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/Development/{{ item }}"
        state: directory
        mode: 0755
      loop: ['Projects', 'Build', 'Scratch', 'Reference', 'Logs']
      tags: core

    - name: Create dotfile directory structure
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/{{ item['path'] }}"
        state: directory
        mode: 0755
      loop: "{{ lookup('community.general.filetree', 'dotfiles/') }}"
      loop_control:
        label: "{{ item['path'] }}"
      when: item['state'] == 'directory'
      tags: core

    - name: Install dotfiles
      ansible.builtin.copy:
        src: "{{ item['src'] }}"
        dest: "{{ ansible_user_dir }}/{{ item['path'] }}"
        mode: 0644
      loop: "{{ lookup('community.general.filetree', 'dotfiles/') }}"
      loop_control:
        label: "{{ item['path'] }}"
      when: item['state'] == 'file'
      tags: core

    - name: Make scripts executable
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/.local/bin"
        state: directory
        mode: 0755
        recurse: true
      tags: core

    - name: Install themes for bat
      vars:
        bat: "{{ 'batcat' if 'Debian' in ansible_os_family else 'bat' }}"
      ansible.builtin.command: "{{ bat }} cache --build"
      changed_when: false
      tags: core

    - name: Install gitconfig
      ansible.builtin.template:
        src: gitconfig.j2
        dest: "{{ ansible_user_dir }}/.gitconfig"
        mode: 0755
        backup: true
      register: _backup_gitconfig
      notify: Process backups
      tags: core

    - name: Ensure backup directory exists
      ansible.builtin.file:
        path: "{{ backups_dir }}"
        state: directory
        mode: 0755
      tags: [always, backups]

    - name: Ensure fonts directory exists
      ansible.builtin.file:
        path: "{{ font_dir }}"
        state: directory
        mode: 0700
      tags: fonts

    - name: Import ssh tasks
      ansible.builtin.import_tasks: tasks/dotfiles/ssh.yml
      tags: [ssh, core]

    - name: Import tmux tasks
      ansible.builtin.import_tasks: tasks/dotfiles/tmux.yml
      tags: [tmux, core]

    - name: Import vim tasks
      ansible.builtin.import_tasks: tasks/dotfiles/vim.yml
      tags: [vim, core]

    - name: Import kubectl tasks
      ansible.builtin.import_tasks: tasks/dotfiles/kubectl.yml
      tags: kubectl

# ============================================================================
#  zsh & completions
# ----------------------------------------------------------------------------

    - name: Install Starship
      ansible.builtin.import_tasks: tasks/dotfiles/starship.yml
      tags: [zsh, starship]

    - name: Generate 1Password-cli completions
      ansible.builtin.shell: "op completion zsh > {{ zsh['completions'] }}/op"
      changed_when: false
      when: "'Darwin' in ansible_system"  # until 1password-cli is added to a repo
      tags: [zsh, 1password]

    - name: Find all zsh completions and sources
      ansible.builtin.find:
        file_type: file
        paths:
          - "{{ zsh['completions'] }}"
          - "{{ zsh['functions'] }}"
      register: find_zsh_source_dirs
      tags: [zsh, core]

    - name: Apply zshrc template
      vars:
        zsh_source_files: "{{ find_zsh_source_dirs['files'] }}"
      ansible.builtin.template:
        src: zshrc.j2
        dest: "{{ ansible_user_dir }}/.zshrc"
        mode: 0644
        backup: true
      register: _backup_zshrc
      notify: Process backups
      tags: [zsh, core]

# ============================================================================
#  assets & modules
# ----------------------------------------------------------------------------

    - name: Copy fonts
      ansible.builtin.copy:
        src: fonts/
        dest: "{{ font_dir }}/"
        mode: 0644
      when: "'desktop' in system_type"
      tags: fonts

    - name: Import GitHub tasks
      ansible.builtin.import_tasks: tasks/dotfiles/github.yml
      tags: github

    - name: Install Python packages
      ansible.builtin.pip:
        name: "{{ python['packages'] }}"
        extra_args: --user
      tags: python

# ============================================================================
#  gui apps configuration
# ----------------------------------------------------------------------------

    - name: Import terminal tasks
      ansible.builtin.import_tasks: tasks/dotfiles/terminals.yml
      tags: terminals

    - name: Import VSCode tasks
      ansible.builtin.import_tasks: tasks/dotfiles/vscode.yml
      tags: vscode

    - name: Import BBEdit tasks
      ansible.builtin.import_tasks: tasks/dotfiles/bbedit.yml
      when: "'Darwin' in ansible_system"
      tags: bbedit

    - name: Update macOS app icons
      vars:
        app: "/Applications/{{ item['path'] | splitext | first }}.app"
      ansible.builtin.include_tasks: tasks/dotfiles/mac_icons.yml
      when: "'Darwin' in ansible_system"
      loop: "{{ lookup('community.general.filetree', 'macOS/icons/') }}"
      loop_control:
        label: "{{ app }}"
      tags: icons
