---

- name: "Export encrypted secrets for 1Password"
  hosts: localhost

  vars:
    output_file: "{{ ansible_facts['user_dir'] }}/.ansible/op.json"
    vault_file: "{{ ansible_facts['user_dir'] }}/.ansible/vault"
    vault_secrets:
      github_token: "{{ git_github_token }}"
      rsa_ssh_key: "{{ ssh_keys['rsa'] }}"
      ed25519_ssh_key: "{{ ssh_keys['ed25519'] }}"

  tasks:
    - name: "Lookup Vault password"
      block:
        - name: "Store Vault password"
          vars:
            vault_password: "{'vault_password': '{{ lookup('ansible.builtin.file', vault_file) }}' }"
          ansible.builtin.set_fact:
            vault_secrets: "{{ vault_secrets | ansible.builtin.combine(vault_password) }}"
      rescue:
        - name: "Store Vault password"
          vars:
            vault_password: "{'vault_password': ''}"
          ansible.builtin.set_fact:
            vault_secrets: "{{ vault_secrets | ansible.builtin.combine(vault_password) }}"

    - name: "Get 1Password Vault id"
      ansible.builtin.command:
        cmd: "op vault get '{{ op_vault }}' --format=json"
      register: cmd_op_vault_get

    - name: "Output decrypted secrets to file"
      vars:
        vault_id: "{{ cmd_op_vault_get['stdout'] | community.general.json_query('id') }}"
      ansible.builtin.template:
        src: "op.json.j2"
        dest: "{{ output_file }}"
        mode: "0600"
