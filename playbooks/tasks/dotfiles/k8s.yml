---

- name: Find kubectl executable
  ansible.builtin.find:
    paths: "{{ ansible_env['PATH'] | split(':') }}"
    patterns: kubectl
    file_type: any
  register: find_kubectl
  tags: kubectl

- name: Install kubectl
  vars:
    url: https://storage.googleapis.com/kubernetes-release/release
    release: "{{ lookup('url', 'https://dl.k8s.io/release/stable.txt') }}"
    arch: "{{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' }}"
  ansible.builtin.get_url:
    url: "{{ url }}/{{ release }}/bin/{{ ansible_system | lower }}/{{ arch }}/kubectl"
    dest: "{{ ansible_user_dir }}/.local/bin/"
    mode: 0755
  when: find_kubectl['matched'] == 0
  tags: kubectl

- name: Generate kubectl completions
  environment:
    PATH: "{{ ansible_env.PATH }}:{{ ansible_user_dir }}/.local/bin"
  ansible.builtin.shell: "kubectl completion zsh > {{ zsh['completions'] }}/kubectl"
  changed_when: false
  tags: kubectl

- name: Install stern
  vars:
    name: stern
  ansible.builtin.include_tasks:
    file: helpers/github_release.yml
    apply:
      tags: stern
  tags: stern

- name: Generate stern completions
  vars:
    stern_bin: "{{ ansible_user_dir }}/.local/bin/stern"
  ansible.builtin.shell: "{{ stern_bin }} --completion=zsh > {{ zsh['completions'] }}/stern"
  changed_when: false
  tags: stern

- name: Install k9s
  vars:
    name: k9s
  ansible.builtin.include_tasks:
    file: helpers/github_release.yml
    apply:
      tags: k9s
  tags: k9s

- name: Generate k9s completions
  vars:
    k9s_bin: "{{ ansible_user_dir }}/.local/bin/k9s"
  ansible.builtin.shell: "{{ k9s_bin }} completion zsh > {{ zsh['completions'] }}/k9s"
  changed_when: false
  tags: k9s

- name: Install k9s configs
  ansible.builtin.copy:
    src: apps/k9s
    dest: "{{ k9s_config_path }}/"
    mode: 0644
  tags: k9s

- name: Download fubectl
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/kubermatic/fubectl/master/fubectl.source
    dest: "{{ zsh['functions'] }}/fubectl"
    mode: 0644
  tags: fubectl

- name: Install Krew installer
  vars:
    name: krew
  ansible.builtin.include_tasks:
    file: helpers/github_release.yml
    apply:
      tags: krew
  tags: krew

- name: Install Krew
  block:
    - name: Check for installer
      ansible.builtin.stat:
        path: "{{ ansible_user_dir }}/.local/bin/krew"
      register: krew_installer
    - name: Install Krew
      ansible.builtin.command:
        cmd: "{{ ansible_user_dir }}/.local/bin/krew install krew"
        creates: "{{ ansible_user_dir }}/.krew/bin/kubectl-krew"
      when:
        krew_installer['stat']['exists']
  always:
    - name: Remove installer
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/.local/bin/krew"
        state: absent
  tags: krew

- name: Install Krew plugins
  environment:
    PATH: "{{ ansible_env['PATH'] }}:{{ ansible_user_dir }}/.local/bin:{{ ansible_user_dir }}/.krew/bin"
  ansible.builtin.command: "kubectl krew install {{ krew_plugins | join(' ') }}"
  register: kubectl_krew_install
  changed_when: "'Installed plugin' in kubectl_krew_install.stdout"
  tags: krew
