---

- name: Find kubectl executable
  ansible.builtin.find:
    paths: "{{ ansible_env['PATH'] | split(':') }}"
    patterns: kubectl
    file_type: any
  register: find_kubectl
  tags: kubectl

- name: Install kubectl
  vars:
    url: https://storage.googleapis.com/kubernetes-release/release
    release: "{{ lookup('url', 'https://dl.k8s.io/release/stable.txt') }}"
    arch: "{{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' }}"
  ansible.builtin.get_url:
    url: "{{ url }}/{{ release }}/bin/{{ ansible_system | lower }}/{{ arch }}/kubectl"
    dest: "{{ ansible_user_dir }}/.local/bin/"
    mode: 0755
  when: find_kubectl['matched'] == 0
  tags: kubectl

- name: Install Krew
  block:
    - name: Download Krew installer
      vars:
        name: krew
        user: kubernetes-sigs
        repo: krew
        arch: "{{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' }}"
        filename: "krew-{{ ansible_system | lower }}_{{ arch }}.tar.gz"
      ansible.builtin.include_tasks:
        file: tasks/helpers/github_release.yml
        apply:
          tags: krew
    - name: Install Krew
      ansible.builtin.command:
        cmd: "{{ ansible_user_dir }}/.local/bin/krew install krew"
        creates: "{{ ansible_user_dir }}/.krew/bin/kubectl-krew"
  always:
    - name: Remove installer
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/.local/bin/krew"
        state: absent
  tags: krew

- name: Install Krew plugins
  environment:
    PATH: "{{ ansible_env['PATH'] }}:{{ ansible_user_dir }}/.local/bin:{{ ansible_user_dir }}/.krew/bin"
  ansible.builtin.command: "kubectl krew install {{ krew_plugins | join(' ') }}"
  register: kubectl_krew_install
  changed_when: "'Installed plugin' in kubectl_krew_install['stdout']"
  tags: krew

- name: Install k9s configs
  ansible.builtin.copy:
    src: apps/k9s
    dest: "{{ k9s_config_path[ansible_distribution] }}/"
    mode: 0644
  tags: k9s
