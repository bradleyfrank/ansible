---

- name: Get Stats version
  environment:
    PATH: "{{ path }}"
  ansible.builtin.shell:
    cmd: brew info --cask stats --json=v2 | jq -r '.casks[].installed'
  changed_when: false
  register: stats_version
  tags: stats

- name: Copy Stats xml config
  ansible.builtin.template:
    src: stats.xml.j2
    dest: /tmp/eu.exelban.Stats.xml
    mode: 0644
  tags: stats

- name: Generate Stats plist config
  vars:
    stats_xml: /tmp/eu.exelban.Stats.xml
    stats_plist: "{{ ansible_user_dir }}/Library/Preferences/eu.exelban.Stats.plist"
  ansible.builtin.command:
    cmd: "plutil -convert binary1 {{ stats_xml }} -o {{ stats_plist }}"
  changed_when: false
  tags: stats

- name: Set app squircle icons
  vars:
    app: "/Applications/{{ item['path'] | splitext | first }}.app"
  ansible.builtin.command: "{{ homebrew_prefix }}/bin/fileicon set {{ app }} {{ item['src'] }}"
  register: cmd_fileicon_set
  changed_when: false
  failed_when:
    - "'you do not have read permissions' in cmd_fileicon_set.stderr"
    - "'file not found or not a (readable) regular file' in cmd_fileicon_set.stderr"
  when: "'Darwin' in ansible_system"
  loop: "{{ lookup('community.general.filetree', 'macOS/icons/') }}"
  loop_control:
    label: "{{ app }}"
  tags: icons
