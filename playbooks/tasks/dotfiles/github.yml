---

- name: Register SSH key with Github
  community.general.github_key:
    name: "{{ ansible_user_id }}@{{ ansible_hostname }}"
    pubkey: "{{ lookup('file', ssh_keys['ed25519'] + '.pub') }}"
    state: present
    token: "{{ github['token'] }}"
  tags: github

- name: Clone repositories
  block:
    - name: Query GitHub API for my repositories
      ansible.builtin.uri:
        url: "https://api.github.com/search/repositories?q=user:{{ github['username'] }}+archived:false"
        headers:
          Authorization: "token {{ github['token'] }}"
      register: github_repos
    - name: Create Git project directories
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/Development/Projects/{{ item['name'] }}/{{ item['default_branch'] }}"
        state: directory
        mode: 0755
      loop: "{{ github_repos['json']['items'] }}"
      loop_control:
        label: "{{ item['name'] }}"
    - name: Clone my GitHub repositories
      ansible.builtin.git:
        repo: "{{ item['clone_url'] | replace('github.com', github['token'] + '@github.com') }}"
        version: "{{ item['default_branch'] }}"
        dest: "{{ ansible_user_dir }}/Development/Projects/{{ item['name'] }}/{{ item['default_branch'] }}"
        accept_hostkey: true
        update: false
      loop: "{{ github_repos['json']['items'] }}"
      loop_control:
        label: "{{ item['name'] }}"
    - name: Update remote origin to SSH url
      community.general.git_config:
        repo: "{{ ansible_user_dir }}/Development/Projects/{{ item['name'] }}/{{ item['default_branch'] }}"
        scope: local
        name: remote.origin.url
        value: "{{ item['ssh_url'] }}"
      loop: "{{ github_repos['json']['items'] }}"
      loop_control:
        label: "{{ item['name'] }}"
  when: clone_personal_repos
  tags: github_repos

- name: Clone reference Git repositories
  ansible.builtin.git:
    repo: "{{ item['https_url'] }}"
    dest: "{{ ansible_user_dir }}/Development/Reference/{{ item['name'] }}"
    depth: '1'
    version: "{{ item['version'] | default('master') }}"
  loop: "{{ git_reference_repos }}"
  loop_control:
    label: "{{ item['name'] }}"
  tags: [github_repos, git_ref_repos]
