---

- name: Check if kubectl is installed
  command: which kubectl
  changed_when: false
  failed_when: which_kubectl['rc'] not in [0,1]
  register: which_kubectl

- name: Install local version of kubectl
  block:
    - name: Find latest kubectl release
      ansible.builtin.get_url:
        url: https://dl.k8s.io/release/stable.txt
        dest: /tmp/kubectl.txt
    - name: Install kubectl
      vars:
        url: https://storage.googleapis.com/kubernetes-release/release
        release: "{{ lookup('file', '/tmp/kubectl.txt') }}"
        system: "{{ ansible_system | lower }}"
      ansible.builtin.get_url:
        url: "{{ url }}/{{ release }}/bin/{{ system }}/amd64/kubectl"
        dest: "{{ ansible_user_dir }}/.local/bin/"
        mode: 0755
    - name: Remove temp file
      ansible.builtin.file:
        path: /tmp/kubectl.txt
        state: absent
  when: which_kubectl['rc'] == 1

- name: Generate kubectl completions
  environment:
    PATH: "{{ ansible_env.PATH }}:{{ ansible_user_dir }}/.local/bin"
  ansible.builtin.shell: "kubectl completion zsh > {{ zsh['completions'] }}/kubectl"
  changed_when: false

- name: Install stern
  vars:
    name: stern
  ansible.builtin.include_tasks:
    file: helpers/github_release.yml
    apply:
      tags: stern
  tags: stern

- name: Generate stern completions
  ansible.builtin.shell: "stern --completion=zsh > {{ zsh['completions'] }}/stern"
  changed_when: false
  tags: stern

- name: Download fubectl
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/kubermatic/fubectl/master/fubectl.source
    dest: "{{ zsh['functions'] }}/fubectl"
    mode: 0644

- name: Install Krew installer
  vars:
    name: krew
  ansible.builtin.include_tasks:
    file: helpers/github_release.yml
    apply:
      tags: krew
  tags: krew

- name: Install Krew
  block:
    - name: Check for installer
      ansible.builtin.stat:
        path: "{{ ansible_user_dir }}/.local/bin/krew"
      register: krew_installer
    - name: Install Krew
      ansible.builtin.command:
        cmd: "{{ ansible_user_dir }}/.local/bin/krew install krew"
        creates: "{{ ansible_user_dir }}/.krew/bin/kubectl-krew"
      when:
        krew_installer['stat']['exists']
  always:
    - name: Remove installer
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/.local/bin/krew"
        state: absent
  tags: krew

- name: Install Krew plugins
  environment:
    PATH: "{{ ansible_env['PATH'] }}:{{ ansible_user_dir }}/.krew/bin"
  ansible.builtin.command: "kubectl krew install {{ krew['plugins'] | join(' ') }}"
  register: kubectl_krew_install
  changed_when: "'Installed plugin' in kubectl_krew_install.stdout"
  tags: krew
