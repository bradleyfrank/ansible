---

- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ hostname }}"
  become: true

- name: Set user shell to zsh and add to groups
  ansible.builtin.user:
    name: "{{ ansible_user_id }}"
    groups: "{{ user_groups }}"
    shell: /usr/bin/zsh
  become: true

- name: Pull latest container images
  containers.podman.podman_image:
    name: "{{ item['repo'] | default('docker.io') }}/{{ item['name'] }}"
  loop: "{{ containers }}"
  tags: containers

- name: Import dconf settings
  community.general.dconf:
    key: "{{ item['key'] }}"
    value: "{{ item['value'] }}"
  loop: "{{ dconf_common | combine(dconf_distro[ansible_distribution]) | dict2items }}"
  when: is_desktop
  tags: dconf

- name: Generate host keys
  ansible.builtin.command:
    cmd: ssh-keygen -A
    creates: /etc/ssh/ssh_host_*_key
  become: true
  tags: ssh

- name: Secure SSH settings
  import_role:
    name: devsec.hardening.ssh_hardening
  become: true
  tags: [ssh, security]
