---

- name: Set user shell to zsh and add to 'docker' group
  ansible.builtin.user:
    name: "{{ ansible_user_id }}"
    groups: docker
    shell: /usr/bin/zsh
  become: true
  tags: shell

- name: Ensure Docker is running
  ansible.builtin.systemd:
    name: docker
    daemon_reload: true
    enabled: true
    state: started
  become: true
  tags: docker

- name: Pull latest Docker images
  environment:
    PYTHONPATH: "{{ ansible_env['PYTHONPATH'] | default('') }}:{{ python_user_site }}"
  community.docker.docker_image:
    name: "{{ item }}"
    source: pull
  loop: "{{ docker_images }}"
  become: true
  tags: docker

- name: Import dconf settings
  ansible.builtin.shell: "dconf load / < {{ item }}"
  with_fileglob:
    - "conf/Gnome/common.dconf"
    - "conf/Gnome/{{ ansible_distribution }}.dconf"
  tags: dconf

- name: Generate host keys
  ansible.builtin.command:
    cmd: ssh-keygen -A
    creates: /etc/ssh/ssh_host_*_key
  become: true
  tags: ssh

- name: Secure SSH settings
  import_role:
    name: devsec.hardening.ssh_hardening
  become: true
  tags: [ssh, security]
