---

- name: Configure shells
  block:
    - name: Make additional shells available
      ansible.builtin.blockinfile:
        path: /etc/shells
        block: |
          /usr/local/bin/bash
          /usr/local/bin/zsh
    - name: Make zsh default for user
      ansible.builtin.user:
        name: "{{ ansible_user_id }}"
        shell: /usr/local/bin/zsh
  become: true
  tags: shell

- name: Fix Alacritty icon
  vars:
    alacritty_dir: "{{ ansible_user_dir }}/.local/share/alacritty"
  block:
    - name: Make folder for icon
      ansible.builtin.file:
        path: "{{ alacritty_dir }}"
        state: directory
        mode: 0755
    - name: Copy icon to system
      ansible.builtin.copy:
        src: conf/MacOSX/alacritty.icns
        dest: "{{ alacritty_dir }}/"
        mode: 0755
    - name: Set new icon
      ansible.builtin.command: "fileicon set /Applications/Alacritty.app {{ alacritty_dir }}/alacritty.icns"
  tags: alacritty

- name: Set macOS default settings
  community.general.osx_defaults:
    domain: "{{ item['domain'] }}"
    key: "{{ item['key'] }}"
    type: "{{ item['type'] | default(omit) }}"
    value: "{{ item['value'] }}"
  loop: "{{ defaults }}"
  tags: system_settings

- name: Put display to sleep after 15 minutes and computer to sleep after 30 minutes
  ansible.builtin.shell: pmset displaysleep 15 && pmset sleep 30
  changed_when: false
  become: true
  tags: power_settings

- name: Enable firewall
  ansible.builtin.command: /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate on
  changed_when: false
  become: true
  tags: [firewall, security]

- name: Disable Gatekeeper
  ansible.builtin.command: spctl --master-disable
  changed_when: false
  become: true
  tags: [gatekeeper, security]

- name: Enable locate database
  ansible.builtin.command: launchctl load -w /System/Library/LaunchDaemons/com.apple.locate.plist
  changed_when: false
  become: true
  tags: locate_db

- name: Unhide ~/Library
  ansible.builtin.shell: "chflags nohidden {{ ansible_user_dir }}/Library &&\
    xattr -d com.apple.FinderInfo {{ ansible_user_dir }}/Library"
  changed_when: false
  tags: unhide_dirs

- name: Unhide /Volumes
  ansible.builtin.command: chflags nohidden /Volumes
  changed_when: false
  become: true
  tags: unhide_dirs

- name: Restart dock to apply changes
  ansible.builtin.command: killall Dock
  changed_when: false
  become: true
  tags: always
