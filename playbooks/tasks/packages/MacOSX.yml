---

- name: Install Homebrew taps
  community.general.homebrew_tap:
    name: "{{ system_packages['taps'] }}"
  tags: [packages, homebrew_taps]

- name: Install Homebrew formulas
  community.general.homebrew:
    name: "{{ system_packages['formulas'] }}"
  tags: [packages, homebrew_formulas]

- name: Install Homebrew casks for all system types
  community.general.homebrew_cask:
    name: "{{ system_packages['casks_common'] }}"
    accept_external_apps: true
  tags: [packages, homebrew_casks]

- name: Install Homebrew casks for bare metal
  community.general.homebrew_cask:
    name: "{{ system_packages['casks_hardware_only'] }}"
    accept_external_apps: true
  when: ansible_model is match('Mac')  # skips installing casks in a virtual machine
  tags: [packages, homebrew_casks]

- name: Check Mac App Store authentication status
  ansible.builtin.shell:
    executable: "{{ bash_shell }}"
    cmd: |
      set -o pipefail
      mas account >&1 | grep -vq 'Not signed in'
  changed_when: false
  failed_when: mas_account['rc'] not in [0,1]
  register: mas_account  # success is not finding 'Not signed in'
  tags: [packages, mac_app_store]

- name: Install apps
  ansible.builtin.command: "mas install {{ item }}"
  loop: "{{ system_packages['apps'] }}"
  when: mas_account['rc'] == 0  # authenticated to mac app store
  tags: [packages, mac_app_store]
