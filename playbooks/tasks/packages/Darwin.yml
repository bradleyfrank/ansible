---

- name: Install Homebrew taps
  community.general.homebrew_tap:
    name: "{{ system_packages['taps'] }}"
  tags: [packages, homebrew_taps]

- name: Install Homebrew formulas
  community.general.homebrew:
    name: "{{ system_packages['formulas'] }}"
  tags: [packages, homebrew_formulas]

- name: Install Homebrew casks for all system types
  community.general.homebrew_cask:
    name: "{{ system_packages['casks_common'] }}"
    accept_external_apps: true
  tags: [packages, homebrew_casks]

- name: Install Homebrew casks for bare metal
  community.general.homebrew_cask:
    name: "{{ system_packages['casks_hardware_only'] }}"
    accept_external_apps: true
  when: ansible_model is match('Mac')  # skips installing casks in a virtual machine
  tags: [packages, homebrew_casks]

- name: Check Mac App Store authentication status
  ansible.builtin.command: mas account
  changed_when: false
  failed_when: mas_account['rc'] not in [0,1]
  register: mas_account
  tags: [packages, mac_app_store]

- name: Install apps
  ansible.builtin.command: "mas install {{ item }}"
  loop: "{{ system_packages['apps'] }}"
  when: mas_account['rc'] == 0
  tags: [packages, mac_app_store]
