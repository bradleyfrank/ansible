---

- name: Lookup GitHub package latest release
  environment:
    PYTHONPATH: "{{ ansible_env['PYTHONPATH'] | default('') }}:{{ python_user_site }}"
  community.general.github_release:
    user: "{{ item['value']['user'] }}"
    repo: "{{ item['key'] }}"
    action: latest_release
    token: "{{ github_token }}"
  register: github_package_metadata
  loop: "{{ github_packages | default({}) | dict2items }}"
  tags: [packages, github]

- name: Include OS-specific packages
  ansible.builtin.include_tasks: "packages/{{ distro_vars[ansible_distribution] }}.yml"
  tags: always

- name: Ensure Docker is running
  ansible.builtin.systemd:
    name: docker
    daemon_reload: true
    enabled: true
    state: started
  become: true
  when: ansible_system == 'Linux'
  tags: docker

- name: Pull latest Docker images
  environment:
    PYTHONPATH: "{{ ansible_env['PYTHONPATH'] | default('') }}:{{ python_user_site }}"
  community.docker.docker_image:
    name: "{{ item }}"
    source: pull
  loop: "{{ docker_images }}"
  tags: docker
