---

- name: Lookup GitHub package latest releases
  community.general.github_release:
    user: "{{ item.user }}"
    repo: "{{ item.repo }}"
    action: latest_release
    token: "{{ github_token }}"
  register: github_packages_metadata
  loop: "{{ github_packages | default({}) }}"
  tags:
    - packages
    - github

- name: Include OS-specific packages
  ansible.builtin.include_tasks: "packages/{{ distro_vars[ansible_distribution] }}.yml"

- name: Get list of installed vscode extensions
  command: code --list-extensions
  changed_when: false
  failed_when: installed_extensions.rc not in [0,1]
  register: installed_extensions
  tags:
    - packages
    - vscode

- name: Install VSCode extensions
  vars:
    extensions_to_install: "{{ vscode_extensions | difference(installed_extensions.stdout_lines) }}"
  ansible.builtin.command: "{{ vscode['bin'] }} --install-extension {{ item }}"
  loop: "{{ extensions_to_install }}"
  tags:
    - packages
    - vscode

- name: Install Python packages
  ansible.builtin.pip:
    name: "{{ python_packages }}"
    extra_args: --user
  tags:
    - packages
    - python

- name: Install Krew
  block:
    - name: Download Krew installer
      ansible.builtin.get_url:
        url: "{{ krew['url'] }}"
        dest: /tmp/krew.tar.gz
    - name: Make directory for extracting Krew installer
      ansible.builtin.file:
        path: /tmp/krew
        state: directory
    - name: Extract Krew installer
      ansible.builtin.unarchive:
        src: /tmp/krew.tar.gz
        dest: /tmp/krew
    - name: Install Krew
      ansible.builtin.command:
        cmd: "/tmp/krew/{{ krew['installer'] }} install krew"
        creates: "{{ ansible_user_dir }}/.krew"
    - name: Cleanup Krew temp files
      ansible.builtin.file:
        path: "/tmp/{{ item }}"
        state: absent
      loop: ['krew.tar.gz', 'krew']
  tags:
    - packages
    - krew
