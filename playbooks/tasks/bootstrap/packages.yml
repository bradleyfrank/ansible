---

- name: Include os-specific package tasks
  ansible.builtin.include_tasks: "tasks/bootstrap/packages/os_{{ ansible_system }}.yml"
  tags: always

- name: Create temp download directory
  ansible.builtin.file:
    path: "{{ github_release_temp_dir }}"
    state: directory
    mode: 0755
  notify: Remove GitHub downloads
  tags: [packages, github_release]

- name: Install Krew
  block:
    - name: Get latest version of Krew
      community.general.github_release:
        user: kubernetes-sigs
        repo: krew
        action: latest_release
        token: "{{ github['personal_token'] }}"
      register: krew_latest_release
    - name: Download latest version of Krew
      vars:
        slug: kubernetes-sigs/krew
        version: "{{ krew_latest_release['tag'] }}"
        arch: "{{ 'amd64' if ansible_architecture == 'x86_64' else ansible_architecture }}"
        filename: "krew-{{ ansible_system | lower }}_{{ arch }}.tar.gz"
      ansible.builtin.get_url:
        url: "https://github.com/{{ slug }}/releases/download/{{ version }}/{{ filename }}"
        dest: "{{ github_release_temp_dir }}/krew.tar.gz"
        mode: 0644
    - name: Extract Krew archive
      ansible.builtin.unarchive:
        src: "{{ github_release_temp_dir }}/krew.tar.gz"
        dest: "{{ github_release_temp_dir }}"
        mode: 0755
    - name: Install Krew
      ansible.builtin.command:
        cmd: "{{ github_release_temp_dir }}/krew install krew"
        creates: "{{ ansible_user_dir }}/.krew/bin/kubectl-krew"
  tags: [packages, github_release]

- name: Install jqp
  block:
    - name: Get latest version of jqp
      community.general.github_release:
        user: noahgorstein
        repo: jqp
        action: latest_release
        token: "{{ github['personal_token'] }}"
      register: jqp_latest_release
    - name: Download latest version of Krew
      vars:
        slug: noahgorstein/jqp
        version: "{{ jqp_latest_release['tag'] }}"
        filename: "jqp_{{ version | replace('v', '', 1) }}_{{ ansible_system }}_{{ ansible_architecture }}.tar.gz"
      ansible.builtin.get_url:
        url: "https://github.com/{{ slug }}/releases/download/{{ version }}/{{ filename }}"
        dest: "{{ github_release_temp_dir }}/jqp.tar.gz"
        mode: 0644
    - name: Extract jqp archive
      ansible.builtin.unarchive:
        src: "{{ github_release_temp_dir }}/jqp.tar.gz"
        dest: "{{ github_release_temp_dir }}"
        mode: 0755
    - name: Copy jqp binary
      ansible.builtin.copy:
        src: "{{ github_release_temp_dir }}/jqp"
        dest: "{{ ansible_user_dir }}/.local/bin/jqp"
        mode: 0755
        remote_src: true
  tags: [packages, github_release]
