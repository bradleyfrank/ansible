#!/usr/bin/env bash

#
# Clones a bare repository, and adds the default branch as a worktree.
# Author: Brad Frank
# Date: September 2021
# Tested: zsh 5.8 (x86_64-apple-darwin19.6.0)
# Requires: git
#

repo_url=$1
repo_name="$(basename "$repo_url")"
repo_name="${repo_name%%.*}"
repo_path="$HOME/Development/Projects/$repo_name"

[[ -d "$repo_path" ]] && exit 1

mkdir -p "$repo_path"
cd "$repo_path" || return 1
git clone "$repo_url" main
cd main || return 1
default_branch="$(git remote show origin | sed -rn 's/\s+HEAD branch:\s+(.*)$/\1/p')"

if [[ $default_branch != main ]]; then
  cd .. || return 1
  mv main "$default_branch"
fi

tmux send-keys -t "$(tmux new-window -n "$repo_name" -P)" "cd ${repo_path}/${default_branch} && clear" C-m
