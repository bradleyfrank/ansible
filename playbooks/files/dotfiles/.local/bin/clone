#!/usr/bin/env bash

#
# Clones a bare repository, and adds the default branch as a worktree.
# Author: Brad Frank
# Date: September 2021
# Tested: zsh 5.8 (x86_64-apple-darwin19.6.0)
# Requires: git, jq
#

repo_url=$1
repo_name="$(basename "$repo_url")"
repo_name="${repo_name%%.*}"
repo_path="$HOME/Development/Projects/$repo_name"

[[ -d "$repo_path" ]] && exit 1

tmp_repo=$(mktemp -d)
pushd "$tmp_repo" || exit 1
git clone "$repo_url"
default_branch="$(git remote show origin | grep 'HEAD branch' | awk '{print $3}')"
repo_branch="$repo_path"/"$default_branch"

[[ -d "$repo_branch" ]] && exit 1

mkdir -p "$repo_path" || exit 1
mv "$tmp_repo"/"$repo_name" "$repo_branch"
tmux new-window -n "$repo_name" -c "$repo_branch"
