#!/usr/bin/env bash

#
# Branches a Git repo in a new tmux window.
# Author: Brad Frank
# Date: May 2021
# Tested: GNU bash, version 5.0.18(1)-release (x86_64-apple-darwin19.6.0)
# Requires: tmux, git
#

repo_name=infractl
branch="$(id -un).$(date +%F_%T | tr -d ':-' | tr '_' '-')"
open_in=window

while getopts ':hr:b:wp' flag; do
    case "${flag}" in
        h) echo "Usage: branch [-r <repo>] [-b <branch_name>] [-w(indow)* | -p(ane) [h*|v]]" ; exit 0 ;;
        p) open_in=pane ; split=${OPTARG:-h} ;;
        r) repo_name=$OPTARG ;;
        b) branch=$OPTARG ;;
        w) open_in=window ;;
        *) echo "Invalid argument." >&2 ; exit 1 ;;
    esac
done

repo_path="$HOME"/Development/Projects/"$repo_name"

cd "$(find "$repo_path"/ -maxdepth 1 -mindepth 1 -type d -exec stat -c "%W %n" {} \; \
  | sort -n | head -n1 | awk '{print $2}')" || exit 1

git worktree add ../"$branch"
repo_branch="$repo_path"/"$branch"

case $open_in in
  window) tmux new-window -n "$repo_name" -c "$repo_branch" ;;
  pane)   case $split in
            v) tmux split-window -v -c "$repo_branch" ;;
            h) tmux split-window -h -c "$repo_branch" ;;
          esac
          ;;
esac
