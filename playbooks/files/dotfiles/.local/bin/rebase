#!/usr/bin/env bash

#
# Wrapper for git-absorb.
# Author: Brad Frank
# Date: Nov 2022
# Tested: GGNU bash, version 5.1.16(1)-release (x86_64-apple-darwin20.6.0)
#

default_branch="$(git remote show origin | awk '/HEAD branch/ {print $NF}')"
current_branch="$(git rev-parse --abbrev-ref HEAD)"
current_head="$(git rev-parse --short HEAD)"

base="$(git log "$default_branch".."$current_branch" --oneline --reverse --pretty=format:"%h" | head -n1)"

if [[ "$base" == "$current_head" ]]; then
  git commit --amend --no-edit
else
  git absorb --base "$base" --and-rebase
fi

