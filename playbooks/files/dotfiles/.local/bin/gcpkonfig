#!/usr/bin/env bash

#
# A script to iterate through GKE clusters in managed GCP projects and create kubectl configs.
# Author: Brad Frank
# Date: Nov 2020
# Tested: GNU bash, version 5.0.18(1)-release (x86_64-apple-darwin19.6.0)
# Requires: google-cloud-sdk, kubectl
#


# ----- functions ----- #

function main() {
    local projects project cluster
    readarray -t -d ',' projects <<< "$@"

    mv ~/.kube/config ~/.ansible/backups/kubeconfig."$(date --iso-8601=seconds | tr -d ':-')"

    for project in "${projects[@]}"; do
      while read -r cluster; do
        if [[ -z "$cluster" ]]; then continue
        else get_credentials "$(tr -d '\n' <<< "$project"),$cluster"
        fi
      done <<< "$(gcloud --project "$(tr -d '\n' <<< "$project")" container clusters list --format="value[separator=','](zone,name)")"
    done
}

function get_credentials() {
    local project region context
    project="$(cut -d, -f1 <<< "$1")"
    region="$(cut -d, -f2 <<< "$1")"
    context="$(cut -d, -f3 <<< "$1")"
    gcloud --project "$project" container clusters get-credentials --region="$region" "$context"
}


# ----- begin ----- #

[[ -z $1 ]] && echo "Usage: gcpkconfigs <project1,project2,projectN>" exit 1
main "$1" || exit 1
exit
