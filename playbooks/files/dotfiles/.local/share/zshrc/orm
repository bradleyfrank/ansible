export ORM_GCP_PROJECTS="binderhub-dev,binderhub-prod,common-build,dataeng-dev-273349,dataeng-prod-308999,kc-core-dev,kc-core-prod,platform-dev-788014,platform-prod-399563,strong-keyword-184513"

# [okonfig] generate kubectl config from GCP projects
okonfig() { gcpkonfig "$ORM_GCP_PROJECTS"; }

# [ogpl] list a subset of ORM GCP projects
ogpl() { gpf "$ORM_GCP_PROJECTS"; }

# [otags] list container image tags
otags() { gtags common-build "$1"; }

# [oghpr] print all open PRs by team members
oghpr() {
    output=$(mktemp)

    while read -r member; do
        author=$(tr -d '\n' <<< "$member")
        printf "\n%s\n\n" "$(toilet --font pagga --width 100 "$author")" >> "$output"
        gh api search/issues?q=state:open+is:pr+author:"$author"+draft:false --jq '.items[] | .title,.html_url' >> "$output"
    done <<< "$(gh api orgs/oreillymedia/teams/platform-engineering/members --jq '.[] | .login' | grep -v "$(gh config get --host github.com user)")"

    mutt bfrank@oreilly.com -s "PE Open PRs" < "$output"
    rm "$output"
}

# [ois] creates python environment for infractl
alias ois='orm-infractl-setup'
orm-infractl-setup() {
    [[ -f ./install.sh ]] || return 1
    rm .env
    bash install.sh env
    bash install.sh
    source ./ve/bin/activate
    bash install.sh deploy-local
}

# [okclean] remove contexts added by infractl
okclean() {
    local context current_context; current_context=$(kubectl config current-context)
    krename; kubectl config unset current-context &> /dev/null
    for context in $(kubectl config get-contexts | awk '(NR>1) {print $1}' | grep -E '^gke'); do
        kubectl config delete-context "$context"
    done
    kubectl config set current-context "$(grep -o '[^_]*$' <<< "$current_context")" &> /dev/null
}

# [_ogp] interactive gcloud project select
alias -g _ogp='--project $(echo -e ${ORM_GCP_PROJECTS//,/\\n} | _inline_fzf_nh_single)'

# [_okc] interactive kubectl context select
alias -g _okc='_kc'

# [gc-] gcloud aliases
alias gc-bhdev='gcloud --project binderhub-dev'
alias gc-bhprod='gcloud --project binderhub-prod'
alias gc-commonbuild='gcloud --project common-build'
alias gc-dataengdev='gcloud --project dataeng-dev-273349'
alias gc-dataeng-prod='gcloud --project dataeng-prod-308999'
alias gc-kcdev='gcloud --project kc-core-dev'
alias gc-kcprod='gcloud --project kc-core-prod'
alias gc-platdatadev='gcloud --project platform-data-dev-301120'
alias gc-platformdev='gcloud --project platform-dev-788014'
alias gc-platformprod='gcloud --project platform-prod-399563'
alias gc-playground='gcloud --project strong-keyword-184513'

# [k-] kubectl aliases
alias k-bhdev='kubectl --context binderhub-dev-cluster'
alias k-bhprod='kubectl --context binderhub-prod-cluster'
alias k-commonbuild='kubectl --context common-build-cluster'
alias k-kcdev='kubectl --context kc-dev'
alias k-kcprod='kubectl --context kc-prod'
alias k-kfdev='kubectl --context kubeflow-dev'
alias k-kfprod='kubectl --context kubeflow-prod'
alias k-platformdev='kubectl --context platform-dev-cluster'
alias k-platformprod='kubectl --context platform-prod-cluster'
alias k-playground='kubectl --context playground-cluster'

# [ohelp] show this help message
ohelp() {
    echo "helper aliases and functions for ORM"
    echo
    grep -E '^# \[.+\]' "${(%):-%x}"
}
