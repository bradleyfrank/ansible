---

- name: "Bootstrap Ansible"
  hosts: all

  vars_prompt:
    - name: bootstrap_hostname
      prompt: "Enter system hostname"
      private: false
      default: "{{ system_hostname | default('localhost') }}"

    - name: bootstrap_email
      prompt: "Enter email address"
      private: false
      default: "{{ user_id | default('user') + '@' + system_hostname | default('localhost') }}"

  tasks:
    - name: "Install Ansible Galaxy requirements"
      community.general.ansible_galaxy_install:
        name: "{{ item }}"
        type: "collection"
        force: true
      loop: "{{ ansible_collections }}"
      tags: [collections]

    - name: "Set hostname"
      ansible.builtin.hostname:
        name: "{{ bootstrap_hostname }}"
      become: true
      tags: [hostname]

    - name: "Check for existing host_vars"
      ansible.builtin.stat:
        path: "{{ inventory_dir }}/host_vars/{{ bootstrap_hostname }}.yml"
      register: stat_host_vars_yml
      tags: [host_vars]

    - name: "Create host_vars"
      vars:
        role_overrides: "{{ lookup('ansible.builtin.file', role_vars, errors='ignore') }}"
      ansible.builtin.template:
        src: "host_vars.yml.j2"
        dest: "{{ inventory_dir }}/host_vars/{{ bootstrap_hostname }}.yml"
        mode: "0755"
      when: not stat_host_vars['stat']['exists']
      tags: [host_vars]
