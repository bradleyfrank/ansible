---

- name: "Bootstrap Ansible"
  hosts: all

  vars:
    host_vars: "{{ inventory_dir }}/host_vars/{{ system_hostname }}.yml"

  vars_prompt:
    - name: bootstrap_hostname
      prompt: "Enter system hostname"
      private: false
      default: "{{ system_hostname }}"

    - name: bootstrap_email
      prompt: "Enter email address"
      private: false

    - name: onepassword_signin_url
      prompt: "Enter the 1Password Signin URL"
      private: false
      confirm: true

    - name: onepassword_email_address
      prompt: "Enter the 1Password Email"
      private: false
      confirm: true

    - name: onepassword_secret_key
      prompt: "Enter the 1Password Secret Key"
      private: true
      confirm: true

    - name: onepassword_account_password
      prompt: "Enter the 1Password Account password"
      private: true
      confirm: true

  tasks:
    - name: "Install Ansible Galaxy requirements"
      community.general.ansible_galaxy_install:
        name: "{{ item }}"
        type: "collection"
        force: true
      loop: "{{ ansible_collections }}"
      tags: [collections]

    - name: "Create host_vars"
      ansible.builtin.template:
        src: "host_vars.yml.j2"
        dest: "{{ host_vars }}"
        mode: "0755"
      tags: [host_vars]

    - name: "Append customized role vars to host_vars"
      ansible.builtin.blockinfile:
        block: "{{ lookup('ansible.builtin.file', role_vars) }}"
        path: "{{ host_vars }}"
        insertafter: "EOF"
      tags: [host_vars]

    - name: "Include 1Password role"
      ansible.builtin.import_role:
        name: "onepassword"
      tags: [onepassword]

    - name: "Generate 1Password session"
      vars:
        onepassword_session_token: "{{ cmd_op_session_token['stdout'] | split('\n') | last }}"
      ansible.builtin.command:
        cmd: "op signin --session {{ onepassword_session_token }} --force"
      register: cmd_op_signin

    - name: "Write 1Password session to file"
      ansible.builtin.lineinfile:
        path: "{{ ansible_facts['user_dir'] }}/.op_session"
        mode: "0400"
        insertbefore: "BOF"
        line: "{{ cmd_op_signin['stdout'] }}"
        create: true
      tags: [onepassword, never]
