---

- name: "Add public SSH keys from Github to `authorized_keys`"
  tags: [github, keys, authorized_keys]
  when: git_ssh_authorized_keys_github
  block:
    - name: "Get list of existing Github SSH keys"
      ansible.builtin.uri:
        url: "{{ git_github_api_ssh_key_url }}"
        method: "GET"
        status_code: [200]
        headers:
          Authorization: "Bearer {{ git_github_token }}"
          Accept: "{{ git_github_api_headers_accept }}"
          X-GitHub-Api-Version: "{{ git_github_api_headers_version }}"
      register: git_ssh_keys
    - name: "Add matching public keys to `authorized_keys`"
      ansible.posix.authorized_key:
        user: "{{ ansible_facts['user_id'] }}"
        key: "{{ item['key'] }} {{ item['title'] }}"
      loop: "{{ git_ssh_keys['json'] | community.general.json_query(git_ssh_authorized_keys_match) }}"
      loop_control:
        label: "{{ item['title'] }}"

- name: "Register SSH key with Github"
  community.general.github_key:
    name: "{{ git_ssh_key_name }}"
    pubkey: "{{ lookup('ansible.builtin.file', git_ssh_key_public) }}"
    state: "present"
    token: "{{ git_github_token }}"
  when: git_ssh_key_upload
  tags: [github, keys]

- name: "Get list of existing Github SSH signing keys"
  ansible.builtin.uri:
    url: "{{ git_github_api_signing_key_url }}"
    method: "GET"
    status_code: [200]
    headers:
      Authorization: "Bearer {{ git_github_token }}"
      Accept: "{{ git_github_api_headers_accept }}"
      X-GitHub-Api-Version: "{{ git_github_api_headers_version }}"
  register: git_ssh_signing_keys
  when: git_signing_key_upload
  tags: [github, signing]

- name: "Register SSH signing key with Github"
  vars:
    key_contents: "{{ lookup('ansible.builtin.file', git_signing_key_file) | split(' ') }}"
    body:
      key: "{{ key_contents[0] }} {{ key_contents[1] }}"
      title: "{{ ansible_facts['user_id'] }}@{{ ansible_facts['hostname'] }}"
  ansible.builtin.uri:
    url: "{{ git_github_api_signing_key_url }}"
    method: "POST"
    body: "{{ body | to_nice_json }}"
    body_format: "json"
    status_code: [201]
    headers:
      Authorization: "Bearer {{ git_github_token }}"
      Accept: "{{ git_github_api_headers_accept }}"
      X-GitHub-Api-Version: "{{ git_github_api_headers_version }}"
  when: "(git_signing_key_upload) and
    (body['key'] not in git_ssh_signing_keys['json'] | map(attribute='key'))"
  tags: [github, signing]
