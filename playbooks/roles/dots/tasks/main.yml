---

- name: Create directories
  ansible.builtin.file:
    path: "{{ ansible_facts['user_dir'] }}/{{ item }}"
    state: "directory"
  loop: "{{ dots_folders }}"
  tags: [dots, dotfiles]

- name: Install dotfiles
  ansible.posix.synchronize:
    src: "{{ dots_files_source }}/"
    dest: "{{ ansible_facts['user_dir'] }}/"
    compress: false
    owner: false
    group: false
  tags: [dots, dotfiles]

- name: Render dotfile templates
  ansible.builtin.template:
    src: "{{ dots_templates_source }}/{{ item['name'] }}"
    dest: "{{ item['dest'] }}/{{ item['name'] | split('.') | first }}"
    mode: "{{ item['mode'] | default('0644') }}"
  loop: "{{ dots_templates }}"
  loop_control:
    label: "{{ item['name'] }}"
  tags: [dots, dotfiles]

- name: Post-processing
  ansible.builtin.command:
    cmd: "{{ item['cmd'] }}"
    creates: "{{ item['creates'] | default(omit) }}"
    removes: "{{ item['removes'] | default(omit) }}"
  changed_when: false
  loop: "{{ dots_post_processing }}"
  tags: [dots, dotfiles]
  loop_control:
    label: "{{ item['name'] }}"
