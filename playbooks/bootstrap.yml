---

- name: Bootstrap localhost
  hosts: localhost
  tasks:

    - name: Add temporary passwordless sudo permissions
      ansible.builtin.copy:
        content: "{{ ansible_user_id }} ALL=(ALL) NOPASSWD: ALL"
        dest: "{{ sudoers }}"
        validate: /usr/sbin/visudo -csf %s
        mode: 0644
      become: true
      notify: Remove passwordless sudo permissions

    - name: Add DNS fallback
      ansible.builtin.lineinfile:
        path: /etc/systemd/resolved.conf
        regexp: '^#?FallbackDNS='
        line: FallbackDNS=9.9.9.9 1.1.1.1 8.8.8.8
      become: true
      when: "'Linux' in ansible_system"

    - name: Include distro-specific packages
      ansible.builtin.include_tasks: "tasks/packages/{{ ansible_distribution }}.yml"
      tags: always

    - name: Install flatpak remotes
      community.general.flatpak_remote:
        name: "{{ item['name'] }}"
        state: present
        flatpakrepo_url: "{{ item['url'] }}"
        method: user
      loop: "{{ flatpaks['remotes'] }}"
      loop_control:
        label: "{{ item['name'] }}"
      when:
        - "'Linux' in ansible_system"
        - "'gui' in system_type"
      tags: [packages, flatpak]

    - name: Install flatpak packages
      community.general.flatpak:
        name: "{{ item['name'] }}"
        state: present
        method: user
        remote: "{{ item['remote'] | default('flathub') }}"
      loop: "{{ flatpaks['packages'] }}"
      when:
        - "'Linux' in ansible_system"
        - "'gui' in system_type"
      tags: [packages, flatpak]

    - name: Install root dotfiles
      ansible.builtin.copy:
        src: root/
        dest: "{{ root_home }}/"
        mode: 0644
      become: true
      tags: [root, dotfiles]

    - name: Configure system settings
      ansible.builtin.include_tasks: "tasks/system/{{ ansible_system }}.yml"
      tags: always

  handlers:
    - name: Remove passwordless sudo permissions
      ansible.builtin.file:
        path: "{{ sudoers }}"
        state: absent
      become: true

- name: Import dotfile playbook
  ansible.builtin.import_playbook: dotfiles.yml
