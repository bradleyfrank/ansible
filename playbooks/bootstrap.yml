---

- name: Bootstrap localhost system
  hosts: localhost
  tasks:
    - name: Add temporary passwordless sudo permissions
      ansible.builtin.copy:
        content: "{{ ansible_user_id }} ALL=(ALL) NOPASSWD: ALL"
        dest: "{{ nopasswd_sudo }}"
        validate: /usr/sbin/visudo -csf %s
        mode: 0644
      become: true
      notify: Remove passwordless sudo permissions

    - name: Stop packagekit
      ansible.builtin.systemd:
        name: packagekit
        state: stopped
      become: true
      when: "'Linux' in ansible_system"

    - name: Add DNS fallback
      ansible.builtin.lineinfile:
        path: /etc/systemd/resolved.conf
        regexp: '^#?FallbackDNS='
        line: FallbackDNS=9.9.9.9 1.1.1.1 8.8.8.8

    - name: Setup Linux repositories
      block:
        - name: Install gpg keys
          ansible.builtin.apt_key:
            url: "{{ item['key'] | default(omit) }}"
            keyring: "{{ item['keyring'] | default(omit) }}"
            id: "{{ item['id'] | default(omit) }}"
            keyserver: "{{ item['keyserver'] | default(omit) }}"
          loop: "{{ repos }}"
          loop_control:
            label: "{{ item['name'] }}"
        - name: Install repositories
          ansible.builtin.apt_repository:
            repo: "{{ item['repo'] }}"
            filename: "{{ item['name'] }}"
          loop: "{{ repos }}"
          loop_control:
            label: "{{ item['name'] }}"
      become: true
      when: "'Linux' in ansible_system"
      tags: repos

    - name: Include OS-specific packages
      ansible.builtin.include_tasks: "tasks/packages/{{ ansible_system }}.yml"
      tags: always

    - name: Make bash default for root
      ansible.builtin.user:
        name: root
        shell: "{{ bash_shell }}"
      become: true
      tags: [root, shell]

    - name: Fix permissions for zsh
      ansible.builtin.file:
        path: "{{ item }}"
        mode: 0755
      loop: "{{ zsh_directories }}"
      when: "'Darwin' in ansible_system"
      tags: shell

    - name: Clone dotfiles repo
      ansible.builtin.git:
        accept_hostkey: true
        depth: 1
        dest: "{{ root_home }}/.dotfiles"
        repo: "{{ dotfiles_collection }}"
        version: main
      become: true
      tags: [root, dotfiles]

    - name: Install root dotfiles
      ansible.builtin.copy:
        remote_src: true
        src: "{{ root_home }}/.dotfiles/{{ root_dotfiles }}/"
        dest: "{{ root_home }}/"
        mode: 0644
      become: true
      tags: [root, dotfiles]

    - name: Configure system settings
      ansible.builtin.include_tasks: "tasks/system/{{ ansible_system }}.yml"
      tags: always

  handlers:
    - name: Remove passwordless sudo permissions
      ansible.builtin.file:
        path: "{{ nopasswd_sudo }}"
        state: absent
      become: true

- name: Import dotfile playbook
  ansible.builtin.import_playbook: dotfiles.yml
