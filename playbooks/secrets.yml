---

- name: Decrypt inventory secrets
  hosts: localhost

  vars:
    output_to_stdout: true
    output_to_file: false
    output_file: "{{ ansible_facts['user_dir'] }}/ansible_vault.yml"
    delete_vault_file: false
    vault_file: "{{ ansible_facts['user_dir'] }}/.ansible/vault"
    vault_secrets:
      - name: "GitHub token"
        variable: "{{ git_github_token }}"
      - name: "rsa SSH key"
        variable: "{{ ssh_keys['rsa'] }}"
      - name: "ed25519 SSH key"
        variable: "{{ ssh_keys['ed25519'] }}"

  tasks:
    - name: Check for vault file
      ansible.builtin.stat:
        path: "{{ vault_file }}"
      register: stat_vault_file

    - name: Add Vault password to output if file exists
      vars:
        vault_password: "{{ lookup('ansible.builtin.file', vault_file) }}"
      ansible.builtin.set_fact:
        vault_secrets: "{{ vault_secrets + [{'name': 'Vault password', 'variable':  vault_password}] }}"
      when: stat_vault_file['stat']['exists']

    - name: Output decrypted inventory secrets to file
      ansible.builtin.template:
        src: "ansible_vault.yml.j2"
        dest: "{{ output_file }}"
        mode: "0600"
      when: output_to_file

    - name: Output decrypted inventory secrets to stdout
      ansible.builtin.debug:
        msg: "{{ item['variable'] }}"
      loop: "{{ vault_secrets }}"
      loop_control:
        label: "{{ item['name'] }}"
      when: output_to_stdout

    - name: Delete vault file
      ansible.builtin.file:
        path: "{{ vault_file }}"
        state: "absent"
      when: delete_vault_file
