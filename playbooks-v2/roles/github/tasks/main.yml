---

- name: Register SSH key with Github
  community.general.github_key:
    name: "{{ github_ssh_key_name }}"
    pubkey: "{{ lookup('ansible.builtin.file', github_ssh_public_key_path) }}"
    state: "present"
    token: "{{ github_token }}"
  when: github_ssh_public_key_upload
  tags: [github, dotfiles, github_ssh_key]

- name: Get list of existing GitHub SSH signing keys
  ansible.builtin.uri:
    url: "{{ github_api_signing_key_url }}"
    method: "GET"
    status_code: [200]
    headers:
      Authorization: "Bearer {{ github_token }}"
      Accept: "{{ github_api_headers_accept }}"
      X-GitHub-Api-Version: "{{ github_api_headers_version }}"
  register: github_ssh_signing_keys
  when: github_ssh_signing_key_upload
  tags: [github, dotfiles, github_signing_key]

- name: Set signing key upload status
  vars:
    key_uploaded: "{{ lookup('ansible.utils.index_of', github_ssh_signing_keys['json'], 'eq', body['title'], 'title') }}"
  ansible.builtin.set_fact:
    github_ssh_signing_key_uploaded: "{{ key_uploaded }}"
    cacheable: true
  tags: [github, dotfiles, github_signing_key]

- name: Register SSH signing key with Github
  vars:
    key_contents: "{{ lookup('ansible.builtin.file', github_ssh_signing_key_path) | split(' ') }}"
    body:
      key: "{{ key_contents[0] }} {{ key_contents[1] }}"
      title: "{{ ansible_facts['user_id'] }}@{{ ansible_facts['hostname'] }}"
  ansible.builtin.uri:
    url: "{{ github_api_signing_key_url }}"
    method: "POST"
    body: "{{ body | to_nice_json }}"
    body_format: "json"
    status_code: [201]
    headers:
      Authorization: "Bearer {{ github_token }}"
      Accept: "{{ github_api_headers_accept }}"
      X-GitHub-Api-Version: "{{ github_api_headers_version }}"
  when: (github_ssh_signing_key_upload) and (not github_ssh_signing_key_uploaded)
  tags: [github, dotfiles, github_signing_key]
