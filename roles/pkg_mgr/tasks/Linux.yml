---

- name: "Stop packagekit"
  ansible.builtin.systemd:
    name: "packagekit"
    state: stopped
    enabled: false
  become: true
  notify: Start packagekit

- name: "Add repositories (apt)"
  ansible.builtin.deb822_repository: "{{ item }}"
  loop: "{{ pkg_mgr_repos }}"
  loop_control:
    label: "{{ item['name'] }}"
  become: true
  when: ansible_facts['pkg_mgr'] == "apt"

- name: "Install gpg keys (dnf)"
  ansible.builtin.rpm_key:
    key: "{{ item['gpgkey'] }}"
    state: present
  loop: "{{ pkg_mgr_repos }}"
  loop_control:
    label: "{{ item['name'] }}"
  become: true
  when: ansible_facts['pkg_mgr'] == "dnf"

- name: "Add repositories (dnf)"
  ansible.builtin.yum_repository: "{{ item }}"
  loop: "{{ pkg_mgr_repos }}"
  loop_control:
    label: "{{ item['name'] }}"
  become: true
  when: ansible_facts['pkg_mgr'] == "dnf"

- name: "Update package manager cache"
  ansible.builtin.package:
    update_cache: true
  become: true

- name: "Install cli packages"
  ansible.builtin.package:
    name: "{{ pkg_mgr_packages['cli'] }}"
    state: present
  become: true

- name: "Install gui packages"
  ansible.builtin.package:
    name: "{{ pkg_mgr_packages['gui'] }}"
    state: present
  when: pkg_mgr_desktop_present
  become: true

- name: "Install DE/WM packages"
  ansible.builtin.package:
    name: "{{ pkg_mgr_packages[item] }}"
    state: present
  loop: "{{ pkg_mgr_packages.keys() | list }}"
  when: item in pkg_mgr_current_desktop
  become: true

- name: "Install Homebrew formulas"
  ansible.builtin.include_tasks:
    file: "homebrew.yml"
  # Checking compatibility avoids errors with arm64 arch that break the play.
  when: (ansible_facts['system'] == 'Darwin') or (ansible_facts['system'] == 'Linux' and
        (ansible_facts['architecture'] == 'x86_64' or ansible_facts['architecture'] == 'amd64'))

- name: "Include Flakpak packages install tasks"
  ansible.builtin.include_tasks:
    file: "flatpak.yml"
  when: pkg_mgr_flatpak_install and (pkg_mgr_flatpak_packages | length > 0)
