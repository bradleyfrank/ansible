---

- name: "Install zsh packages"
  ansible.builtin.package:
    name: "{{ zsh_packages }}"
  become: "{{ true if ansible_facts['system'] == 'Linux' else false }}"
  tags: [install]

- name: "Get current Zsh version"
  ansible.builtin.command:
    cmd: "{{ zsh_bin }} --version"
  register: cmd_zsh_version
  changed_when: false
  tags: [dots]

- name: "Set current Zsh version"
  ansible.builtin.set_fact:
    zsh_current_version: "{{ (cmd_zsh_version['stdout'] | split)[1] }}"
  tags: [dots]

- name: "Ensure supplemental Zsh directories exist"
  ansible.builtin.file:
    path: "{{ item }}"
    state: "directory"
    mode: "0744"
  loop: "{{ zsh_supplemental_dirs }}"
  tags: [moredots]

- name: "Configure Homebrew Zsh for MacOS"
  when: ansible_facts['system'] == "Darwin"
  become: true
  block:
    - name: "Add Homebrew Zsh to available shells"
      ansible.builtin.lineinfile:
        path: "/etc/shells"
        line: "{{ global_homebrew_prefix }}/bin/zsh"
    - name: "Fix Homebrew Zsh folder permissions"
      ansible.builtin.file:
        path: "{{ item }}"
        mode: "0755"
      loop: "{{ zsh_chmod_directories }}"

- name: "Set Zsh as default shell"
  ansible.builtin.user:
    name: "{{ ansible_facts['user_id'] }}"
    shell: "{{ zsh_bin }}"
  when: ansible_facts['user_shell'] != zsh_bin
  become: true

- name: "Install Zsh plugins"
  ansible.builtin.git:
    repo: "{{ item['repo'] }}"
    dest: "{{ zsh_plugins_dir }}/{{ item['name'] }}"
    depth: 1
    version: "{{ item['version'] | default(omit) }}"
  loop: "{{ zsh_plugins }}"
  loop_control:
    label: "{{ item['name'] }}"
  tags: [moredots]

- name: "Apply zshrc template"
  ansible.builtin.template:
    src: "zshrc.j2"
    dest: "{{ ansible_facts['user_dir'] }}/.zshrc"
    mode: "0644"
  tags: [dots]

- name: "Refresh Zsh completions"
  tags: [moredots, completions]
  block:
    - name: "Generate completions"
      ansible.builtin.shell:
        cmd: "{{ item['command'] }} > {{ zsh_functions_dir }}/_{{ item['name'] }}"
      changed_when: false
      loop: "{{ zsh_completions }}"
      loop_control:
        label: "{{ item['name'] }}"
    - name: "Delete zcompdump"
      ansible.builtin.file:
        path: "{{ ansible_facts['user_dir'] }}/.zcompdump"
        state: absent
    - name: "Generate zcompdump"
      ansible.builtin.shell:
        cmd: "autoload -Uz compinit && compinit"
        executable: "{{ zsh_bin }}"
        creates: "{{ ansible_facts['user_dir'] }}/.zcompdump"
