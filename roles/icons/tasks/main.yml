---

- name: Install `fileicon`
  community.general.homebrew:
    name: "fileicon"
    state: "present"
  when: ansible_facts['system'] == "Darwin"
  tags: [icons]

- name: Check if custom icons are present
  ansible.builtin.stat:
    path: "{{ icons_path }}"
  register: stat_icons_dir

- name: Set app squircle icons
  vars:
    app: "/Applications/{{ item['path'] | splitext | first }}.app"
  ansible.builtin.command:
    cmd: "{{ icons_homebrew_prefix }}/bin/fileicon set {{ app }} {{ item['src'] }}"
  register: cmd_fileicon_set
  changed_when: false
  failed_when:
    - "'you do not have read permissions' in cmd_fileicon_set['stderr']"
    - "'file not found or not a (readable) regular file' in cmd_fileicon_set['stderr']"
  loop: "{{ lookup('community.general.filetree', inventory_dir + '/files/icons/') }}"
  loop_control:
    label: "{{ app }}"
  when: (ansible_facts['system'] == "Darwin") and (stat_icons_dir['exists'])
  tags: [icons]
