---

- name: "Add account to 1Password-cli"
  vars:
    address: "--address {{ onepassword_signin_url }}"
    email: "--email {{ onepassword_email_address }}"
    secret_key: "--secret-key {{ onepassword_secret_key }}"
  ansible.builtin.expect:
    command: "op account add {{ address }} {{ email }} {{ secret_key }}"
    responses:
      Enter the password: "{{ onepassword_account_password }}"
  tags: [onepassword, auth]

- name: "Confirm account is present in 1Password"
  ansible.builtin.command:
    cmd: "op account list --format json"
  register: cmd_op_account_list
  changed_when: false
  failed_when: cmd_op_account_list['stdout'] | from_json | length == 0
  tags: [onepassword, auth]

- name: "Generate session token"
  ansible.builtin.expect:
    command: "op signin --raw"
    responses:
      Enter the password: "{{ onepassword_account_password }}"
  register: cmd_op_session_token
  tags: [onepassword, auth]
