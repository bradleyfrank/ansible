---

- name: "Add account to 1Password-cli"
  vars:
    address: "--address {{ onepassword_signin_url }}"
    email: "--email {{ onepassword_email_address }}"
    secret_key: "--secret-key {{ onepassword_secret_key }}"
  ansible.builtin.expect:
    command: "op account add {{ address }} {{ email }} {{ secret_key }}"
    responses:
      Enter the password: "{{ onepassword_account_password }}"
  tags: [onepassword, auth]

- name: "Confirm account is present in 1Password"
  ansible.builtin.command:
    cmd: "op account list --format json"
  register: cmd_op_account_list
  changed_when: (cmd_op_account_list['stdout'] | from_json)[0]['user_uuid'] is defined
  failed_when: (cmd_op_account_list['stdout'] | from_json)[0]['user_uuid'] is not defined
  tags: [onepassword, auth]

- name: "Generate session token"
  ansible.builtin.expect:
    command: "op signin --raw"
    responses:
      Enter the password: "{{ onepassword_account_password }}"
  register: cmd_op_session_token
  tags: [onepassword, auth]

- name: "Generate 1Password session"
  vars:
    # Split output because the first line is the 'Enter password' prompt.
    onepassword_session_token: "{{ cmd_op_session_token['stdout'] | split('\n') | last }}"
  ansible.builtin.command:
    cmd: "op signin --session {{ onepassword_session_token }} --force"
  changed_when: true
  register: cmd_op_signin

- name: "Write 1Password session to file"
  ansible.builtin.lineinfile:
    path: "{{ onepassword_session_file }}"
    mode: "0400"
    insertbefore: "BOF"
    line: "{{ cmd_op_signin['stdout'] }}"
    create: true
  tags: [onepassword, auth]
  when: onepassword_write_session_file
