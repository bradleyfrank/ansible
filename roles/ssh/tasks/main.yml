---

- name: "Ensure SSH directory is present"
  ansible.builtin.file:
    mode: "0755"
    path: "{{ ansible_facts['user_dir'] }}/.ssh"
    state: "directory"
  tags: [ssh, dotfiles]

- name: "Set proper permissions on ~/.ssh/authorized_keys"
  ansible.builtin.file:
    mode: "0600"
    path: "{{ ansible_facts['user_dir'] }}/.ssh/authorized_keys"
    state: touch
  tags: [ssh, dotfiles]

- name: "Copy user SSH keys"
  tags: [ssh, keys, dotfiles]
  block:
    - name: "Copy user SSH private keys"
      ansible.builtin.copy:
        content: "{{ item['value']['private_key'] }}"
        dest: "{{ ansible_facts['user_home'] }}/.ssh/{{ item['key'] }}"
        mode: "0600"
      loop: "{{ ssh_user_keys | dict2items }}"
    - name: "Copy user SSH public keys"
      ansible.builtin.copy:
        content: "{{ item['value']['public_key'] }}"
        dest: "{{ ansible_facts['user_home'] }}/.ssh/{{ item['key'] }}"
        mode: "0644"
      loop: "{{ ssh_user_keys | dict2items }}"

- name: "Create SSH config"
  ansible.builtin.template:
    src: "{{ lookup('ansible.builtin.first_found', ssh_template_config) }}"
    dest: "{{ ansible_facts['user_dir'] }}/.ssh/config"
    mode: "0644"
    force: "{{ ssh_manage_config_force }}"
  when: ssh_manage_config
  tags: [ssh, config, dotfiles]

- name: "Create host keys"
  community.crypto.openssh_keypair:
    path: "/etc/ssh/ssh_host_{{ item }}_key"
    type: "{{ item }}"
  loop: "{{ ssh_host_keys }}"
  loop_control:
    label: "{{ item }}"
  become: true
  when: (ansible_facts['system'] == "Linux") and (ssh_manage_host_keys)
  tags: [ssh, host_keys, become]

- name: "Set SSH hardening vars for Linux Mint"
  ansible.builtin.set_fact:
    os_vars: "{{ ssh_hardening['Debian'] }}"
  when: (ansible_facts['distribution'] in ["Linux_Mint", "LMDE"])
  tags: [ssh, hardening]

- name: "Secure SSH settings"
  ansible.builtin.include_role:
    name: devsec.hardening.ssh_hardening
  become: true
  tags: [ssh, hardening, become]
  when: (ansible_facts['system'] == "Linux") and (ssh_harden_security)
